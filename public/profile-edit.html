<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Your Profile | CUNYServe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for enhanced UI */
        :root {
            --primary: #00539B;
            --primary-light: #E6F0F8;
        }

        body {
            background-color: #f8fafc;
        }

        .section-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .section-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background-color: var(--primary-light);
        }

        .checkbox-label input:checked~.checkmark {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .photo-upload {
            position: relative;
            width: 10rem;
            height: 10rem;
        }

        .photo-upload:hover .photo-overlay {
            opacity: 1;
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 83, 155, 0.7);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            color: white;
            cursor: pointer;
        }

        .progress-bar {
            height: 0.25rem;
            background-color: #e2e8f0;
            border-radius: 0.125rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .profile-completion {
            position: sticky;
            top: 1rem;
        }

        .checkmark {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            position: relative;
            margin-right: 0.5rem;
        }

        .checkmark.checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .checkmark.checked::after {
            content: "";
            position: absolute;
            left: 0.25rem;
            top: 0.1rem;
            width: 0.3rem;
            height: 0.6rem;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="navbar-placeholder"></div>

    <main class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column - Profile Completion -->
            <div class="lg:w-1/4">
                <div class="profile-completion section-card p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Profile Completion</h2>
                    <div class="progress-bar mb-2">
                        <div id="completion-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="completion-text" class="text-sm text-gray-600">0% complete</p>

                    <div class="mt-6 space-y-4">
                        <div class="flex items-center">
                            <div id="photo-check" class="checkmark"></div>
                            <span class="ml-2 text-sm">Profile Photo</span>
                        </div>
                        <div class="flex items-center">
                            <div id="bio-check" class="checkmark"></div>
                            <span class="ml-2 text-sm">Bio</span>
                        </div>
                        <div class="flex items-center">
                            <div id="prefs-check" class="checkmark"></div>
                            <span class="ml-2 text-sm">Preferences</span>
                        </div>
                        <div class="flex items-center">
                            <div id="skills-check" class="checkmark"></div>
                            <span class="ml-2 text-sm">Skills</span>
                        </div>
                        <div class="flex items-center">
                            <div id="emergency-check" class="checkmark"></div>
                            <span class="ml-2 text-sm">Emergency Contact</span>
                        </div>
                    </div>

                    <button type="button" onclick="window.location.href='/dashboard.html'"
                        class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Right Column - Form -->
            <div class="lg:w-3/4">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Edit Your Volunteer Profile</h1>
                    <p class="mt-2 text-gray-600">Complete your profile to get better volunteer matches</p>
                </div>

                <form id="edit-profile-form" class="space-y-6">
                    <!-- Section 1: Photo & Bio -->
                    <div class="section-card p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Public Profile</h2>
                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <div class="photo-upload">
                                <img id="profile_photo_preview" src="/uploads/default-avatar.png" alt="Profile Picture"
                                    class="w-full h-full rounded-full object-cover border-4 border-white shadow">
                                <div class="photo-overlay" onclick="document.getElementById('profile_photo').click()">
                                    <span class="text-sm font-medium">Change Photo</span>
                                </div>
                                <input type="file" id="profile_photo" accept="image/*" class="hidden">
                            </div>
                            <div class="flex-1 w-full">
                                <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Short Bio</label>
                                <textarea id="bio" rows="5"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    placeholder="Tell us about yourself..."></textarea>
                                <p class="mt-2 text-sm text-gray-500">This will be visible to organizations you
                                    volunteer with.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Matching Preferences -->
                    <div class="section-card p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Matching Preferences</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Preferred Boroughs</h3>
                                <div class="space-y-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="boroughs_preferred" value="Bronx" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Bronx</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="boroughs_preferred" value="Brooklyn"
                                            class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Brooklyn</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="boroughs_preferred" value="Manhattan"
                                            class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Manhattan</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="boroughs_preferred" value="Queens" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Queens</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="boroughs_preferred" value="Staten Island"
                                            class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Staten Island</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Opportunity Types</h3>
                                <div class="space-y-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="opportunity_types" value="One-Time" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>One-Time</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="opportunity_types" value="Ongoing" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Ongoing</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="opportunity_types" value="Remote/Virtual"
                                            class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Remote/Virtual</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="opportunity_types" value="On-Site" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>On-Site</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Causes & Skills -->
                    <div class="section-card p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Causes & Skills</h2>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Causes You Care About</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Education & Tutoring"
                                            class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Education & Tutoring</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Environmental" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Environmental</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Healthcare" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Healthcare</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Food Security" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Food Security</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Advocacy" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Advocacy</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="causes" value="Animals" class="hidden">
                                        <span class="checkmark mr-2"></span>
                                        <span>Animals</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="skills" class="block text-sm font-medium text-gray-700 mb-1">Your Skills
                                    (comma separated)</label>
                                <input type="text" id="skills"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    placeholder="e.g., Public Speaking, Spanish, CPR">
                                <p class="mt-2 text-sm text-gray-500">These skills will help match you with relevant
                                    opportunities.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Academic & Logistics -->
                    <div class="section-card p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Academic & Logistics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="major_program" class="block text-sm font-medium text-gray-700 mb-1">Major /
                                    Program</label>
                                <input type="text" id="major_program"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="graduation_year"
                                    class="block text-sm font-medium text-gray-700 mb-1">Expected Graduation
                                    Year</label>
                                <input type="number" id="graduation_year" min="2023" max="2030"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    placeholder="e.g., 2026">
                            </div>
                            <div>
                                <label for="transport_mode" class="block text-sm font-medium text-gray-700 mb-1">Primary
                                    Mode of Transport</label>
                                <select id="transport_mode"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Select an option</option>
                                    <option value="Public Transit">Public Transit</option>
                                    <option value="Car">Car</option>
                                    <option value="Bike">Bike</option>
                                    <option value="None">None</option>
                                </select>
                            </div>
                            <div>
                                <label for="shirt_size" class="block text-sm font-medium text-gray-700 mb-1">T-Shirt
                                    Size (Optional)</label>
                                <select id="shirt_size"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Select a size</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Emergency Contact & Consent -->
                    <div class="section-card p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Emergency Contact & Consent</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="emergency_name"
                                    class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact Name</label>
                                <input type="text" id="emergency_name"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="emergency_relationship"
                                    class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
                                <input type="text" id="emergency_relationship"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="emergency_phone"
                                    class="block text-sm font-medium text-gray-700 mb-1">Emergency Phone</label>
                                <input type="tel" id="emergency_phone"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">Communication Preferences</h3>
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="checkbox" id="comms_consent_email"
                                        class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Receive emails about new opportunities and
                                        news</span>
                                </label>
                                <label class="flex items-start">
                                    <input type="checkbox" id="comms_consent_sms"
                                        class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Receive SMS alerts for event
                                        reminders</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Submission Button -->
                    <div class="flex justify-end">
                        <button type="submit"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Save All Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Load navbar
            const navbarPlaceholder = document.getElementById('navbar-placeholder');
            if (navbarPlaceholder) {
                try {
                    const response = await fetch('/navbar.html');
                    navbarPlaceholder.innerHTML = await response.text();
                } catch (error) {
                    console.error('Failed to load navbar:', error);
                }
            }

            // Helper functions
            const byId = (id) => document.getElementById(id);
            const setValue = (id, val) => { const el = byId(id); if (el) el.value = val ?? ''; };
            const setChecked = (id, val) => { const el = byId(id); if (el) el.checked = !!val; };
            const setSrc = (id, val, fallback) => { const el = byId(id); if (el) el.src = val || fallback || ''; };

            // Checkbox helpers
            const populateCheckboxes = (name, values) => {
                const valuesSet = new Set(values || []);
                document.querySelectorAll(`input[name="${name}"]`).forEach((checkbox) => {
                    checkbox.checked = valuesSet.has(checkbox.value);
                    // Update visual checkmark
                    const checkmark = checkbox.closest('.checkbox-label')?.querySelector('.checkmark');
                    if (checkmark) {
                        checkmark.classList.toggle('checked', checkbox.checked);
                    }
                });
            };

            // Calculate profile completion percentage
            const calculateCompletion = (data) => {
                const profile = data.profile || {};
                const user = data.user || {};
                const orientation = data.orientation || {};

                let completedFields = 0;
                const totalFields = 5; // photo, bio, prefs, skills, emergency

                // Photo check
                if (user.profilePicture && user.profilePicture !== '/uploads/default-avatar.png') {
                    completedFields++;
                    byId('photo-check').classList.add('checked');
                }

                // Bio check
                if (profile.bio && profile.bio.trim().length > 0) {
                    completedFields++;
                    byId('bio-check').classList.add('checked');
                }

                // Preferences check (at least one borough and one opportunity type)
                if ((profile.boroughs_preferred?.length > 0) && (profile.opportunity_types?.length > 0)) {
                    completedFields++;
                    byId('prefs-check').classList.add('checked');
                }

                // Skills check
                if (profile.skills?.length > 0) {
                    completedFields++;
                    byId('skills-check').classList.add('checked');
                }

                // Emergency contact check
                if (orientation.emergency_name && orientation.emergency_phone) {
                    completedFields++;
                    byId('emergency-check').classList.add('checked');
                }

                const percentage = Math.round((completedFields / totalFields) * 100);
                byId('completion-progress').style.width = `${percentage}%`;
                byId('completion-text').textContent = `${percentage}% complete`;
            };

            // Populate form with data
            const populateForm = (data) => {
                const profile = data.profile || {};
                const user = data.user || {};
                const orientation = data.orientation || {};

                // Section 1: Public Profile
                setSrc('profile_photo_preview', user.profilePicture, '/uploads/default-avatar.png');
                setValue('bio', profile.bio || '');

                // Section 2 & 3: Preferences, Causes & Skills
                populateCheckboxes('boroughs_preferred', profile.boroughs_preferred);
                populateCheckboxes('opportunity_types', profile.opportunity_types);
                populateCheckboxes('causes', profile.causes);
                setValue('skills', Array.isArray(profile.skills) ? profile.skills.join(', ') : '');

                // Section 4: Academic & Logistics
                setValue('major_program', profile.major_program || '');
                setValue('graduation_year', profile.graduation_year || '');
                setValue('transport_mode', profile.transport_mode || '');
                setValue('shirt_size', profile.shirt_size || '');

                // Section 5: Emergency & Consent
                setValue('emergency_name', orientation.emergency_name || '');
                setValue('emergency_relationship', orientation.emergency_relationship || '');
                setValue('emergency_phone', orientation.emergency_phone || '');
                setChecked('comms_consent_email', orientation.comms_consent_email || false);
                setChecked('comms_consent_sms', orientation.comms_consent_sms || false);

                // Calculate completion percentage
                calculateCompletion(data);
            };

            // Load profile data
            const loadProfileData = async () => {
                try {
                    const res = await fetch('/api/profile/all');
                    if (!res.ok) {
                        alert('Failed to load your profile data. Please log in again.');
                        window.location.href = '/login.html';
                        return;
                    }
                    const allData = await res.json();
                    populateForm(allData);
                } catch (error) {
                    console.error('Failed to load profile data:', error);
                    alert('Network error while loading your profile. Please try again.');
                }
            };

            // Photo upload preview
            const photoInput = byId('profile_photo');
            if (photoInput) {
                photoInput.addEventListener('change', () => {
                    const file = photoInput.files && photoInput.files[0];
                    if (!file) return;

                    // Validate file type
                    if (!file.type.match('image.*')) {
                        alert('Please select an image file (JPEG, PNG, etc.)');
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image must be less than 5MB');
                        return;
                    }

                    const preview = byId('profile_photo_preview');
                    if (preview) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            preview.src = e.target.result;
                            // Update completion percentage
                            byId('photo-check').classList.add('checked');
                            updateCompletionPercentage();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Update completion percentage when form changes
            const updateCompletionPercentage = () => {
                let completedFields = 0;
                const totalFields = 5;

                // Photo
                if (photoInput.files && photoInput.files.length > 0) {
                    completedFields++;
                } else if (byId('profile_photo_preview').src.includes('default-avatar.png') === false) {
                    completedFields++;
                }

                // Bio
                if (byId('bio').value.trim().length > 0) {
                    completedFields++;
                }

                // Preferences
                const boroughsChecked = document.querySelectorAll('input[name="boroughs_preferred"]:checked').length > 0;
                const opportunitiesChecked = document.querySelectorAll('input[name="opportunity_types"]:checked').length > 0;
                if (boroughsChecked && opportunitiesChecked) {
                    completedFields++;
                }

                // Skills
                if (byId('skills').value.trim().length > 0) {
                    completedFields++;
                }

                // Emergency contact
                if (byId('emergency_name').value.trim().length > 0 && byId('emergency_phone').value.trim().length > 0) {
                    completedFields++;
                }

                const percentage = Math.round((completedFields / totalFields) * 100);
                byId('completion-progress').style.width = `${percentage}%`;
                byId('completion-text').textContent = `${percentage}% complete`;

                // Update checkmarks
                byId('photo-check').classList.toggle('checked', completedFields >= 1);
                byId('bio-check').classList.toggle('checked', byId('bio').value.trim().length > 0);
                byId('prefs-check').classList.toggle('checked', boroughsChecked && opportunitiesChecked);
                byId('skills-check').classList.toggle('checked', byId('skills').value.trim().length > 0);
                byId('emergency-check').classList.toggle('checked',
                    byId('emergency_name').value.trim().length > 0 && byId('emergency_phone').value.trim().length > 0);
            };

            // Add event listeners for form changes
            const form = byId('edit-profile-form');
            if (form) {
                form.addEventListener('input', updateCompletionPercentage);
                form.addEventListener('change', updateCompletionPercentage);
            }

            // Form submission
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Disable submit button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.disabled = true;

                    try {
                        // Step 1: Upload photo if changed
                        if (photoInput.files && photoInput.files[0]) {
                            const formData = new FormData();
                            formData.append('profilePicture', photoInput.files[0]);

                            const photoRes = await fetch('/api/profile/photo', {
                                method: 'POST',
                                body: formData
                            });

                            if (!photoRes.ok) {
                                throw new Error('Photo upload failed');
                            }
                        }

                        // Step 2: Prepare other data
                        const getCheckedValues = (name) =>
                            Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

                        const profileData = {
                            bio: byId('bio').value,
                            skills: byId('skills').value.split(',').map(s => s.trim()).filter(Boolean),
                            boroughs_preferred: getCheckedValues('boroughs_preferred'),
                            opportunity_types: getCheckedValues('opportunity_types'),
                            causes: getCheckedValues('causes'),
                            major_program: byId('major_program').value,
                            graduation_year: byId('graduation_year').value,
                            transport_mode: byId('transport_mode').value,
                            shirt_size: byId('shirt_size').value,
                        };

                        const orientationData = {
                            emergency_name: byId('emergency_name').value,
                            emergency_relationship: byId('emergency_relationship').value,
                            emergency_phone: byId('emergency_phone').value,
                            comms_consent_email: byId('comms_consent_email').checked,
                            comms_consent_sms: byId('comms_consent_sms').checked,
                        };

                        // Step 3: Save profile data
                        const saveRes = await fetch('/api/profile/all', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ profileData, orientationData }),
                        });

                        if (!saveRes.ok) {
                            throw new Error('Profile save failed');
                        }

                        alert('Profile updated successfully! Redirecting to dashboard...');
                        window.location.href = '/dashboard.html';
                    } catch (error) {
                        console.error('Error saving profile:', error);
                        alert('Error saving profile: ' + error.message);
                        if (submitBtn) submitBtn.disabled = false;
                    }
                });
            }

            // Initialize
            await loadProfileData();
        });
    </script>

<script src="//unpkg.com/alpinejs" defer></script>

<script>
    async function loadNavbar() {
        try {
            const response = await fetch('/navbar.html');
            const data = await response.text();
            document.getElementById('navbar-placeholder').innerHTML = data;

            const dynamicScript = document.createElement('script');
            dynamicScript.src = '/scripts/navbar-dynamic.js';
            document.body.appendChild(dynamicScript);
        } catch (error) {
            console.error('Failed to load navbar:', error);
        }
    }
    loadNavbar();

    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('verified') === 'true') {
            const successEl = document.getElementById('verification-success');
            successEl.classList.remove('hidden');
            setTimeout(() => {
                successEl.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => successEl.classList.add('hidden'), 500);
            }, 5000);
        }
    });
</script>
</body>

</html>